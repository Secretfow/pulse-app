<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PULSE MUSIC</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root {
    --bg-body: #09090b;
    --bg-card: #18181b;
    --bg-input: #27272a;
    --text-main: #ffffff;
    --text-muted: #a1a1aa;
    --border: rgba(255,255,255,0.08);
    --primary: #8b5cf6;
    --accent: #d946ef;
    --grad: linear-gradient(135deg, var(--primary), var(--accent));
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
    font-family: 'Manrope', sans-serif;
    background: var(--bg-body);
    color: var(--text-main);
    margin: 0;
    height: 100dvh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* HEADER */
.app-header {
    flex-shrink: 0;
    padding: 10px 15px; padding-top: max(10px, env(safe-area-inset-top));
    background: rgba(9, 9, 11, 0.95);
    display: flex; flex-direction: column; gap: 10px;
    padding-bottom: 10px;
    z-index: 50;
    border-bottom: 1px solid var(--border);
}
.header-top { display: flex; align-items: center; justify-content: space-between; width: 100%; }
.brand { font-weight: 800; font-size: 20px; background: var(--grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: -0.5px; }
.btn-icon { background: none; border: none; color: var(--text-main); font-size: 20px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

/* SEARCH */
.search-box { width: 100%; position: relative; }
.search-inp { width: 100%; background: var(--bg-input); border: none; border-radius: 12px; padding: 10px 15px 10px 40px; color: white; font-size: 15px; outline: none; }
.search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 14px; }

/* LIST */
.music-list {
    flex: 1; overflow-y: auto; padding: 15px;
    display: flex; flex-direction: column; gap: 10px;
    padding-bottom: 140px; 
}
.track-card {
    background: transparent; border-radius: 12px; padding: 8px;
    display: flex; align-items: center; gap: 12px; transition: 0.2s; cursor: pointer;
    position: relative;
    border: 1px solid transparent;
}
.track-card:active { background: var(--bg-card); transform: scale(0.98); }
.track-card.active { background: rgba(139, 92, 246, 0.1); border-color: rgba(139, 92, 246, 0.2); }
.track-card.active .track-title { color: var(--primary); }

.track-cover-list { width: 48px; height: 48px; border-radius: 8px; object-fit: cover; background: var(--bg-input); flex-shrink: 0; }
.track-info { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; }
.track-title { font-weight: 700; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }

.track-artist-row { display: flex; align-items: center; gap: 6px; }
.artist-ava { width: 16px; height: 16px; border-radius: 50%; object-fit: cover; background: #333; border: 1px solid rgba(255,255,255,0.1); }
.track-artist { font-size: 12px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

.playing-icon { display: none; color: var(--primary); font-size: 14px; }
.track-card.active .playing-icon { display: block; }

.btn-delete {
    background: transparent;
    color: #ef4444; width: 32px; height: 32px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; cursor: pointer; z-index: 2; margin-left: 5px;
    transition: 0.2s;
}
.btn-delete:active { background: rgba(239, 68, 68, 0.2); }

/* MINI PLAYER */
.mini-player {
    position: fixed; bottom: 0; left: 0; width: 100%;
    background: rgba(24, 24, 27, 0.95); backdrop-filter: blur(20px);
    border-top: 1px solid var(--border);
    padding: 8px 12px; padding-bottom: max(15px, env(safe-area-inset-bottom));
    display: flex; align-items: center; gap: 12px;
    z-index: 100; transform: translateY(100%); transition: transform 0.3s;
    cursor: pointer;
}
.mini-player.visible { transform: translateY(0); }

.mp-cover { width: 40px; height: 40px; border-radius: 6px; object-fit: cover; background: #333; }
.mp-info { flex: 1; min-width: 0; }
.mp-title { font-size: 13px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.mp-artist { font-size: 11px; color: var(--text-muted); }
.mp-controls { display: flex; align-items: center; gap: 15px; }
.mp-btn { background: none; border: none; color: white; font-size: 20px; padding: 5px; }
.mini-progress { position: absolute; top: -2px; left: 0; width: 100%; height: 2px; background: transparent; }
.mini-progress-bar { height: 100%; background: var(--grad); width: 0%; transition: width 0.1s linear; }

/* FULL PLAYER */
.full-player {
    position: fixed; inset: 0; background: #000; z-index: 200;
    display: flex; flex-direction: column;
    padding: 20px; padding-top: max(20px, env(safe-area-inset-top));
    padding-bottom: max(30px, env(safe-area-inset-bottom));
    transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.86, 0, 0.07, 1);
    opacity: 0; pointer-events: none;
}
.full-player.open { transform: translateY(0); opacity: 1; pointer-events: auto; }
.fp-header { display: flex; justify-content: center; align-items: center; height: 50px; position: relative; margin-bottom: 20px; }
.fp-close-btn { position: absolute; left: 0; background: none; border: none; color: white; font-size: 24px; padding: 10px; }
.fp-title-top { font-size: 14px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

.fp-cover-container { flex: 1; display: flex; align-items: center; justify-content: center; max-height: 45vh; margin-bottom: 30px; }
.fp-cover { width: 100%; aspect-ratio: 1/1; max-width: 350px; border-radius: 20px; object-fit: cover; box-shadow: 0 10px 40px rgba(139, 92, 246, 0.3); }

.fp-info { margin-bottom: 20px; }
.fp-track-title { font-size: 22px; font-weight: 800; margin-bottom: 5px; line-height: 1.2; }
.fp-track-artist { font-size: 16px; color: var(--text-muted); font-weight: 500; }

.fp-progress-container { width: 100%; margin-bottom: 20px; }
.fp-slider { width: 100%; -webkit-appearance: none; height: 4px; background: rgba(255,255,255,0.2); border-radius: 2px; outline: none; margin-bottom: 8px; }
.fp-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; border-radius: 50%; background: white; cursor: pointer; }
.fp-times { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-muted); font-weight: 600; font-variant-numeric: tabular-nums; }

.fp-controls { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
.fp-btn { background: none; border: none; color: white; font-size: 20px; padding: 10px; opacity: 0.8; }
.fp-btn.active { color: var(--primary); opacity: 1; text-shadow: 0 0 10px var(--primary); }
.fp-play-btn { width: 70px; height: 70px; border-radius: 50%; background: white; color: black; font-size: 28px; display: flex; align-items: center; justify-content: center; opacity: 1; }
.fp-lyrics-btn { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--border); padding: 12px; border-radius: 12px; color: var(--text-muted); font-weight: 600; font-size: 14px; }

/* MODALS */
.sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000; opacity: 0; pointer-events: none; transition: 0.3s; }
.sheet-overlay.open { opacity: 1; pointer-events: auto; }
.action-sheet {
    position: fixed; bottom: -100%; left: 0; width: 100%;
    background: #18181b; border-radius: 24px 24px 0 0;
    padding: 24px; z-index: 3001; transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1);
    border-top: 1px solid var(--border);
    padding-bottom: max(24px, env(safe-area-inset-bottom));
    display: flex; flex-direction: column; gap: 15px; max-height: 85vh; overflow-y: auto;
}
.action-sheet.open { bottom: 0; }
.custom-inp { background: var(--bg-input); border: 1px solid var(--border); color: white; padding: 12px 16px; border-radius: 12px; width: 100%; outline: none; }
.btn-primary-block { background: var(--grad); color: white; border: none; padding: 14px; border-radius: 16px; font-weight: 700; width: 100%; }
.lyrics-content { white-space: pre-wrap; color: #e4e4e7; font-size: 16px; line-height: 1.6; text-align: center; padding: 10px; }
.label-sm { font-size: 12px; font-weight: 700; color: var(--text-muted); margin-bottom: -10px; margin-left: 4px; }

</style>
</head>
<body>

<!-- HEADER -->
<div class="app-header">
    <div class="header-top">
        <button class="btn-icon" onclick="window.location.href='index.html'"><i class="fas fa-chevron-left"></i></button>
        <div class="brand">PULSE MUSIC</div>
        <button class="btn-icon" onclick="openUpload()"><i class="fas fa-plus"></i></button>
    </div>
    <div class="search-box">
        <i class="fas fa-search search-icon"></i>
        <input type="text" class="search-inp" id="searchInp" placeholder="Поиск треков..." oninput="filterMusic()">
    </div>
</div>

<!-- LIST -->
<div class="music-list" id="musicList">
    <div class="text-center mt-5 text-muted">Загрузка...</div>
</div>

<!-- MINI PLAYER -->
<div class="mini-player" id="miniPlayer" onclick="openFullPlayer()">
    <div class="mini-progress"><div class="mini-progress-bar" id="miniProgressBar"></div></div>
    <img src="" class="mp-cover" id="mpCover">
    <div class="mp-info">
        <div class="mp-title" id="mpTitle">Трек</div>
        <div class="mp-artist" id="mpArtist">Исполнитель</div>
    </div>
    <div class="mp-controls">
        <button class="mp-btn" onclick="event.stopPropagation(); togglePlay()"><i class="fas fa-play" id="mpPlayIcon"></i></button>
        <button class="mp-btn" onclick="event.stopPropagation(); nextTrack()"><i class="fas fa-step-forward"></i></button>
    </div>
</div>

<!-- FULL PLAYER OVERLAY -->
<div class="full-player" id="fullPlayer">
    <div class="fp-header">
        <button class="fp-close-btn" onclick="closeFullPlayer()"><i class="fas fa-chevron-down"></i></button>
        <div class="fp-title-top">Сейчас играет</div>
    </div>
    
    <div class="fp-cover-container">
        <img src="" class="fp-cover" id="fpCover">
    </div>
    
    <div class="fp-info">
        <div class="fp-track-title" id="fpTitle">Трек</div>
        <div class="fp-track-artist" id="fpArtist">Исполнитель</div>
    </div>
    
    <div class="fp-progress-container">
        <input type="range" class="fp-slider" id="fpSlider" value="0" min="0" max="100" step="0.1" oninput="seekAudio()">
        <div class="fp-times">
            <span id="fpCurrentTime">0:00</span>
            <span id="fpDuration">0:00</span>
        </div>
    </div>
    
    <div class="fp-controls">
        <button class="fp-btn" id="btnShuffle" onclick="toggleShuffle()"><i class="fas fa-random"></i></button>
        <button class="fp-btn" onclick="prevTrack()"><i class="fas fa-step-backward" style="font-size: 26px;"></i></button>
        <button class="fp-play-btn" onclick="togglePlay()"><i class="fas fa-play" id="fpPlayIcon"></i></button>
        <button class="fp-btn" onclick="nextTrack()"><i class="fas fa-step-forward" style="font-size: 26px;"></i></button>
        <button class="fp-btn" id="btnRepeat" onclick="toggleRepeat()"><i class="fas fa-redo"></i></button>
    </div>
    
    <button class="fp-lyrics-btn" onclick="openLyrics()"><i class="fas fa-align-center me-2"></i> Текст песни</button>
</div>

<!-- UPLOAD MODAL -->
<div class="sheet-overlay" id="uploadOverlay" onclick="closeUpload()"></div>
<div class="action-sheet" id="uploadSheet">
    <h4 class="fw-bold mb-3">Загрузить трек</h4>
    <label class="label-sm">Файл (mp3)</label>
    <input type="file" id="audioFile" class="custom-inp" accept="audio/*">
    <label class="label-sm">Обложка</label>
    <input type="file" id="coverFile" class="custom-inp" accept="image/*">
    <label class="label-sm">Название</label>
    <input type="text" id="trackTitle" class="custom-inp">
    <label class="label-sm">Текст (опционально)</label>
    <textarea id="trackLyrics" class="custom-inp" rows="3"></textarea>
    <button class="btn-primary-block mt-3" onclick="uploadTrack()" id="uploadBtn">Загрузить</button>
</div>

<!-- LYRICS MODAL -->
<div class="sheet-overlay" id="lyricsOverlay" onclick="closeLyrics()"></div>
<div class="action-sheet" id="lyricsSheet" style="height:80vh">
    <div class="d-flex justify-content-between mb-3">
        <h5 class="fw-bold">Текст песни</h5>
        <i class="fas fa-times clickable" onclick="closeLyrics()" style="font-size:20px"></i>
    </div>
    <div class="lyrics-content" id="lyricsBody"></div>
</div>

<script type="module">
// ИСПОЛЬЗУЕМ V6 для профиля
const DB_VER = 'pulse_rt_v6_'; 
// ИСПОЛЬЗУЕМ V2 для музыки (чтобы сбросить баги)
const MUSIC_PATH = 'music_v2'; 

import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getDatabase, ref, push, onValue, get, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyBWdArSLBKMgWLAjq3DZ9xgcDUYsv10jvA",
    authDomain: "rodina-d57b8.firebaseapp.com",
    databaseURL: "https://rodina-d57b8-default-rtdb.firebaseio.com",
    projectId: "rodina-d57b8",
    storageBucket: "rodina-d57b8.appspot.com",
    messagingSenderId: "87881339832",
    appId: "1:87881339832:web:c2d61b2027c6a58bd281c5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const SUPABASE_URL = 'https://jeguddarxswnpbhdituv.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplZ3VkZGFyeHN3bnBiaGRpdHV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNjQyMDgsImV4cCI6MjA4MzY0MDIwOH0.6ym579jQrBpGX0pRLpl8MdsRHcYX5iEDw1uMHGgYELY';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const BUCKET = 'pulse_media';

let me = null;
let usersCache = {};

// PLAYER LOGIC
let audio = new Audio();
let playlist = []; 
let filteredPlaylist = [];
let currentIndex = -1;
let isPlaying = false;
let isShuffle = false;
let repeatMode = 0; 

async function init() {
    const localId = localStorage.getItem('pm_uid');
    if (!localId) { window.location.href = 'index.html'; return; }
    
    onValue(ref(db, `${DB_VER}users`), (snap) => {
        if(snap.exists()) {
            usersCache = snap.val();
            me = usersCache[localId];
            if(playlist.length > 0) renderList();
        }
    });

    if(!me) {
        const meSnap = await get(ref(db, `${DB_VER}users/${localId}`));
        if(meSnap.exists()) me = meSnap.val();
        else { window.location.href = 'index.html'; return; }
    }
    
    loadMusic();
    setupAudioListeners();
}

function loadMusic() {
    // СЛУШАЕМ ПАПКУ MUSIC_V2
    onValue(ref(db, `${DB_VER}${MUSIC_PATH}`), (snap) => {
        const list = document.getElementById('musicList');
        
        if(!snap.exists()) { 
            list.innerHTML = '<div class="text-center mt-5 text-muted">Пока нет треков</div>'; 
            playlist = []; filteredPlaylist=[]; 
            return; 
        }
        
        playlist = [];
        snap.forEach(c => {
            const data = c.val();
            if(data) {
                // Добавляем key и валидируем
                playlist.push({ key: c.key, ...data });
            }
        });
        
        // Сортировка: Новые сверху. (Проверка на наличие ts)
        playlist.sort((a,b) => (b.ts || 0) - (a.ts || 0));
        
        // При обновлении данных - обновляем и фильтрованный список
        // (если поиск пуст, показываем всё)
        const q = document.getElementById('searchInp').value.toLowerCase();
        if(!q) {
            filteredPlaylist = [...playlist];
        } else {
            // Если что-то введено, фильтруем новый список
            filterMusic();
            return; // renderList вызовется в filterMusic
        }
        
        renderList();
    });
}

function renderList() {
    const list = document.getElementById('musicList');
    list.innerHTML = '';
    
    if(filteredPlaylist.length === 0) { list.innerHTML = '<div class="text-center mt-5 text-muted">Нет результатов</div>'; return; }

    filteredPlaylist.forEach((t) => {
        try {
            const author = usersCache[t.ownerId] || { name: 'Неизвестный', photo: '' };
            const authorAva = author.photo || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
            const isActive = (currentIndex !== -1 && playlist[currentIndex] && playlist[currentIndex].key === t.key);
            
            const div = document.createElement('div');
            div.className = `track-card ${isActive ? 'active' : ''}`;
            
            let deleteBtnHTML = '';
            if(me && String(t.ownerId) === String(me.id)) {
                deleteBtnHTML = `<div class="btn-delete" onclick="event.stopPropagation(); deleteTrack('${t.key}')"><i class="fas fa-trash"></i></div>`;
            }
            
            div.onclick = () => {
                const realIdx = playlist.findIndex(x => x.key === t.key);
                playTrack(realIdx);
            };
            
            div.innerHTML = `
                <img src="${t.coverUrl || 'https://cdn-icons-png.flaticon.com/512/3844/3844724.png'}" class="track-cover-list">
                <div class="track-info">
                    <div class="track-title">${t.title}</div>
                    <div class="track-artist-row">
                        <img src="${authorAva}" class="artist-ava">
                        <div class="track-artist">${author.name}</div>
                    </div>
                </div>
                ${isActive ? '<div class="playing-icon me-2"><i class="fas fa-chart-bar"></i></div>' : ''}
                ${deleteBtnHTML}
            `;
            list.appendChild(div);
        } catch (e) {
            console.error("Error rendering item:", e);
        }
    });
}

window.filterMusic = () => {
    const q = document.getElementById('searchInp').value.toLowerCase();
    filteredPlaylist = playlist.filter(t => {
        const authorName = usersCache[t.ownerId] ? usersCache[t.ownerId].name.toLowerCase() : '';
        return t.title.toLowerCase().includes(q) || authorName.includes(q);
    });
    renderList();
}

window.deleteTrack = (key) => {
    if(confirm('Удалить этот трек?')) {
        remove(ref(db, `${DB_VER}${MUSIC_PATH}/${key}`))
            .catch(e => alert("Ошибка удаления: " + e.message));
    }
}

// --- AUDIO ---

window.playTrack = (index) => {
    if(index === -1 || !playlist[index]) return;

    if(index === currentIndex) { togglePlay(); return; }
    
    currentIndex = index;
    const track = playlist[index];
    
    audio.src = track.url;
    audio.play().catch(e => console.log("PLAY ERROR:", e));
    isPlaying = true;
    
    updateUI();
    renderList();
    
    document.getElementById('miniPlayer').classList.add('visible');
    
    if ('mediaSession' in navigator) {
        const author = usersCache[track.ownerId]?.name || 'PULSE';
        navigator.mediaSession.metadata = new MediaMetadata({
            title: track.title,
            artist: author,
            artwork: [{ src: track.coverUrl || 'https://cdn-icons-png.flaticon.com/512/3844/3844724.png', sizes: '512x512', type: 'image/png' }]
        });
        navigator.mediaSession.setActionHandler('play', togglePlay);
        navigator.mediaSession.setActionHandler('pause', togglePlay);
        navigator.mediaSession.setActionHandler('previoustrack', prevTrack);
        navigator.mediaSession.setActionHandler('nexttrack', nextTrack);
    }
}

window.togglePlay = () => {
    if(!audio.src) return;
    if(audio.paused) { audio.play(); isPlaying = true; } 
    else { audio.pause(); isPlaying = false; }
    updateUI();
    renderList(); 
}

window.nextTrack = () => {
    if(playlist.length === 0) return;
    
    if(repeatMode === 2) { audio.currentTime = 0; audio.play(); return; }
    
    let nextIdx;
    if(isShuffle) {
        nextIdx = Math.floor(Math.random() * playlist.length);
    } else {
        nextIdx = currentIndex + 1;
        if(nextIdx >= playlist.length) {
            if(repeatMode === 1) nextIdx = 0; 
            else return; 
        }
    }
    playTrack(nextIdx);
}

window.prevTrack = () => {
    if(audio.currentTime > 3) { audio.currentTime = 0; return; }
    let prevIdx = currentIndex - 1;
    if(prevIdx < 0) prevIdx = playlist.length - 1;
    playTrack(prevIdx);
}

window.toggleShuffle = () => {
    isShuffle = !isShuffle;
    document.getElementById('btnShuffle').classList.toggle('active', isShuffle);
}

window.toggleRepeat = () => {
    repeatMode = (repeatMode + 1) % 3;
    const btn = document.getElementById('btnRepeat');
    btn.classList.remove('active');
    btn.innerHTML = '<i class="fas fa-redo"></i>';
    
    if(repeatMode === 1) { btn.classList.add('active'); }
    else if (repeatMode === 2) { btn.classList.add('active'); btn.innerHTML = '<i class="fas fa-redo-alt"></i><span style="font-size:10px;position:absolute;">1</span>'; }
}

window.seekAudio = () => {
    const slider = document.getElementById('fpSlider');
    const time = (slider.value / 100) * audio.duration;
    audio.currentTime = time;
}

function setupAudioListeners() {
    audio.addEventListener('timeupdate', () => {
        if(audio.duration) {
            const pct = (audio.currentTime / audio.duration) * 100;
            document.getElementById('miniProgressBar').style.width = pct + '%';
            document.getElementById('fpSlider').value = pct;
            
            document.getElementById('fpCurrentTime').innerText = formatTime(audio.currentTime);
            document.getElementById('fpDuration').innerText = formatTime(audio.duration);
        }
    });
    audio.addEventListener('ended', nextTrack);
}

function updateUI() {
    if(currentIndex === -1 || !playlist[currentIndex]) return;
    
    const t = playlist[currentIndex];
    const auth = usersCache[t.ownerId]?.name || 'Неизвестный';
    const cover = t.coverUrl || 'https://cdn-icons-png.flaticon.com/512/3844/3844724.png';
    
    document.getElementById('mpTitle').innerText = t.title;
    document.getElementById('mpArtist').innerText = auth;
    document.getElementById('mpCover').src = cover;
    document.getElementById('mpPlayIcon').className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
    
    document.getElementById('fpTitle').innerText = t.title;
    document.getElementById('fpArtist').innerText = auth;
    document.getElementById('fpCover').src = cover;
    document.getElementById('fpPlayIcon').className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
}

function formatTime(s) {
    if(!s || isNaN(s)) return '0:00';
    const min = Math.floor(s / 60);
    const sec = Math.floor(s % 60);
    return `${min}:${sec<10?'0':''}${sec}`;
}

window.openFullPlayer = () => { document.getElementById('fullPlayer').classList.add('open'); }
window.closeFullPlayer = () => { document.getElementById('fullPlayer').classList.remove('open'); }
window.openUpload = () => { document.getElementById('uploadOverlay').classList.add('open'); document.getElementById('uploadSheet').classList.add('open'); }
window.closeUpload = () => { document.getElementById('uploadOverlay').classList.remove('open'); document.getElementById('uploadSheet').classList.remove('open'); }

window.openLyrics = () => {
    if(currentIndex === -1) return;
    const txt = playlist[currentIndex].lyrics || "Текста нет";
    document.getElementById('lyricsBody').innerText = txt;
    document.getElementById('lyricsOverlay').classList.add('open');
    document.getElementById('lyricsSheet').classList.add('open');
}
window.closeLyrics = () => { document.getElementById('lyricsOverlay').classList.remove('open'); document.getElementById('lyricsSheet').classList.remove('open'); }

// UPLOAD FUNCTION
window.uploadTrack = async () => {
    const audioF = document.getElementById('audioFile').files[0];
    const coverF = document.getElementById('coverFile').files[0];
    const title = document.getElementById('trackTitle').value.trim();
    const lyrics = document.getElementById('trackLyrics').value.trim();
    const btn = document.getElementById('uploadBtn');

    if(!audioF || !title) { alert('Нужен файл и название!'); return; }
    if(audioF.size > 20*1024*1024) { alert('Файл > 20МБ'); return; }

    btn.disabled = true; btn.innerText = 'Загрузка...';

    try {
        const ext = audioF.name.split('.').pop();
        const aName = `music/${Date.now()}_a.${ext}`;
        const { error: e1 } = await supabase.storage.from(BUCKET).upload(aName, audioF);
        if(e1) throw e1;
        const aUrl = supabase.storage.from(BUCKET).getPublicUrl(aName).data.publicUrl;

        let cUrl = null;
        if(coverF) {
            const cExt = coverF.name.split('.').pop();
            const cName = `covers/${Date.now()}_c.${cExt}`;
            const { error: e2 } = await supabase.storage.from(BUCKET).upload(cName, coverF);
            if(e2) throw e2;
            cUrl = supabase.storage.from(BUCKET).getPublicUrl(cName).data.publicUrl;
        }

        // Сохраняем в папку MUSIC_V2
        await push(ref(db, `${DB_VER}${MUSIC_PATH}`), {
            title, lyrics, url: aUrl, coverUrl: cUrl,
            ownerId: me.id, ts: Date.now()
        });
        
        alert('Готово!'); closeUpload();
        document.getElementById('audioFile').value='';
        document.getElementById('trackTitle').value='';
        document.getElementById('trackLyrics').value='';
        document.getElementById('coverFile').value='';
        
    } catch(e) {
        console.error("UPLOAD ERROR:", e);
        alert('Ошибка: '+e.message);
    } finally {
        btn.disabled = false; btn.innerText = 'Загрузить';
    }
}

init();
</script>
</body>
</html>