<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>PULSE MARKET - Rodina RP</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&subset=cyrillic&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/ru.min.js"></script>
<style>
:root[data-theme="dark"] {
    color-scheme: dark; /* ВАЖНО: Говорит браузеру использовать темные системные меню */
    --bg-body: #09090b; 
    --bg-card: #1c1c1e; 
    --bg-modal: #27272a;
    --bg-input: #3f3f46;
    --text-main: #ffffff; 
    --text-muted: #a1a1aa;
    --border: rgba(255,255,255,0.1); 
    --primary: #8b5cf6; 
    --accent: #d946ef;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --grad-card: linear-gradient(145deg, #1c1c1e, #222225);
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { 
    font-family: 'Manrope', sans-serif; 
    background: var(--bg-body); 
    color: var(--text-main); 
    margin: 0; 
    min-height: 100dvh; 
    padding-bottom: 90px; 
}

/* HEADER */
.market-header {
    position: sticky; top: 0; z-index: 50;
    background: rgba(9, 9, 11, 0.95);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    padding: 15px 20px;
    display: flex; justify-content: space-between; align-items: center;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
}
.brand-market { 
    font-weight: 800; font-size: 18px; letter-spacing: 1px;
    background: linear-gradient(to right, #10b981, #3b82f6); 
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
    text-transform: uppercase;
}

/* FILTERS */
.filter-scroll {
    display: flex; gap: 8px; overflow-x: auto; padding: 15px 15px 5px;
    scrollbar-width: none;
}
.filter-chip {
    padding: 8px 18px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 20px;
    font-size: 13px;
    white-space: nowrap;
    color: var(--text-muted);
    cursor: pointer;
    transition: 0.2s;
    font-weight: 600;
}
.filter-chip.active {
    background: #fff;
    color: #000;
    border-color: #fff;
    box-shadow: 0 0 15px rgba(255,255,255,0.3);
}

/* ITEM CARD */
.market-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 20px;
    padding: 15px;
}
.item-card {
    background: var(--grad-card);
    border-radius: 20px;
    border: 1px solid var(--border);
    overflow: hidden;
    position: relative;
    display: flex;
    flex-direction: column;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    transition: transform 0.2s;
}
.item-card:active { transform: scale(0.99); }

.item-img {
    width: 100%;
    height: 220px;
    object-fit: cover;
    background: #000;
    border-bottom: 1px solid var(--border);
}
.item-content { padding: 15px; flex: 1; display:flex; flex-direction:column; gap: 8px; }

.item-header-row { display: flex; justify-content: space-between; align-items: start; gap: 10px; }
.item-badges { display: flex; gap: 5px; flex-wrap: wrap; }
.badge-base { font-size: 10px; padding: 4px 8px; border-radius: 6px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
.badge-srv { background: #3b82f6; color: #fff; box-shadow: 0 0 10px rgba(59, 130, 246, 0.4); }
.badge-type-sell { background: var(--success); color: #fff; box-shadow: 0 0 10px rgba(16, 185, 129, 0.4); }
.badge-type-buy { background: var(--warning); color: #000; }
.badge-type-rent { background: var(--accent); color: #fff; }

.item-title { font-weight: 800; font-size: 18px; color: #fff; line-height: 1.2; }
.item-desc { 
    font-size: 14px; 
    color: #d1d5db; 
    line-height: 1.5; 
    white-space: pre-wrap;       
    overflow-wrap: break-word;   
    word-break: break-word;
    background: rgba(255,255,255,0.03);
    padding: 10px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.05);
}

.item-price { 
    font-size: 22px; font-weight: 900; 
    color: #10b981; 
    text-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
    margin-top: 5px;
}
.item-price span { font-size: 14px; font-weight: 600; color: #fff; opacity: 0.7; }

.item-footer {
    padding: 12px 15px;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(0,0,0,0.3);
    backdrop-filter: blur(5px);
}
.seller-info { display: flex; align-items: center; gap: 10px; font-size: 13px; color: #eee; font-weight: 600; }
.seller-ava { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border); }

/* ADMIN BUTTONS ON CARD */
.manage-btns {
    position: absolute; top: 10px; right: 10px;
    display: flex; gap: 8px; z-index: 5;
}
.btn-manage {
    width: 36px; height: 36px;
    border-radius: 50%;
    background: rgba(0,0,0,0.6);
    color: #fff;
    display: flex; align-items: center; justify-content: center;
    backdrop-filter: blur(10px);
    cursor: pointer;
    font-size: 14px;
    transition: 0.2s;
    border: 1px solid rgba(255,255,255,0.1);
}
.btn-manage.del:hover { background: var(--danger); border-color: var(--danger); }
.btn-manage.edit:hover { background: var(--primary); border-color: var(--primary); }

/* MODALS */
.sheet { position: fixed; bottom: -100%; left: 0; width: 100%; background: var(--bg-modal); border-radius: 25px 25px 0 0; padding: 25px 20px; z-index: 2000; transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1); max-height: 90vh; overflow-y: auto; box-shadow: 0 -10px 40px rgba(0,0,0,0.8); border-top: 1px solid var(--border); }
.sheet.open { bottom: 0; }
.overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1500; opacity: 0; pointer-events: none; transition: 0.3s; backdrop-filter: blur(5px); }
.overlay.open { opacity: 1; pointer-events: auto; }

.inp { width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); padding: 14px 16px; border-radius: 14px; margin-bottom: 12px; font-size: 16px; outline: none; transition: 0.2s; }
.inp:focus { border-color: var(--primary); background: rgba(255,255,255,0.05); }
.btn-main { width: 100%; padding: 16px; border-radius: 14px; border: none; background: linear-gradient(135deg, #10b981, #059669); color: #fff; font-weight: 700; font-size: 16px; cursor: pointer; box-shadow: 0 5px 20px rgba(16, 185, 129, 0.3); transition: 0.2s; }
.btn-main:active { transform: scale(0.98); }

/* FAB BUTTON */
.fab-add {
    position: fixed; bottom: 30px; right: 20px;
    width: 64px; height: 64px;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    color: #fff; font-size: 26px;
    box-shadow: 0 10px 30px rgba(139, 92, 246, 0.5);
    z-index: 100; cursor: pointer; transition: 0.2s; border: 2px solid rgba(255,255,255,0.2);
}
.fab-add:active { transform: scale(0.9) rotate(90deg); }

/* ИСПРАВЛЕНИЕ ВЫПАДАЮЩИХ СПИСКОВ */
select.inp { 
    appearance: none; 
    -webkit-appearance: none; /* Для Safari/Chrome на iOS */
    background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); 
    background-repeat: no-repeat; 
    background-position: right 15px top 50%; 
    background-size: 12px auto; 
    background-color: var(--bg-input);
    color: #fff;
}

/* Принудительный цвет фона опций */
select.inp option {
    background-color: #27272a;
    color: #fff;
}

.contact-modal-content { text-align: center; }
.contact-row { background: var(--bg-input); padding: 15px; border-radius: 16px; margin-bottom: 10px; display:flex; justify-content:space-between; align-items:center; border: 1px solid var(--border); }
</style>
</head>
<body>

<div class="market-header">
    <a href="index.html" class="text-decoration-none text-white"><i class="fas fa-arrow-left fs-4"></i></a>
    <div class="brand-market">RODINA MARKET</div>
    <div style="width:24px"></div>
</div>

<!-- FILTERS -->
<div class="filter-scroll">
    <div class="filter-chip active" onclick="filterItems('all', this)">Все</div>
    <div class="filter-chip" onclick="filterItems('sell', this)">Продажа</div>
    <div class="filter-chip" onclick="filterItems('buy', this)">Скупка</div>
    <div class="filter-chip" onclick="filterItems('rent', this)">Аренда</div>
    <div style="width:1px; background:var(--border); flex-shrink:0;"></div>
    <div class="filter-chip" onclick="filterItems('cat_car', this)">Авто</div>
    <div class="filter-chip" onclick="filterItems('cat_acc', this)">Аксы</div>
    <div class="filter-chip" onclick="filterItems('cat_house', this)">Недвижка</div>
    <div class="filter-chip" onclick="filterItems('cat_biz', this)">Бизнес</div>
    <div class="filter-chip" onclick="filterItems('cat_sim', this)">Симки</div>
</div>

<!-- SEARCH -->
<div class="px-3 pb-2 pt-2">
    <div style="position:relative">
        <input type="text" id="marketSearch" class="inp mb-0" placeholder="Поиск товара (например, BMW M5)..." oninput="searchMarket(this.value)" style="padding-left: 45px;">
        <i class="fas fa-search" style="position:absolute; left:15px; top:17px; color:var(--text-muted)"></i>
    </div>
</div>

<!-- LIST -->
<div id="marketGrid" class="market-grid">
    <div class="text-center text-muted w-100 mt-5">Загрузка объявлений...</div>
</div>

<!-- ADD BUTTON -->
<div class="fab-add" onclick="openAddModal()">
    <i class="fas fa-plus"></i>
</div>

<!-- OVERLAY -->
<div class="overlay" id="overlay" onclick="closeAll()"></div>

<!-- ADD ITEM MODAL -->
<div class="sheet" id="modalAddItem">
    <h4 class="fw-bold mb-3">Новое объявление</h4>
    
    <div class="row g-2">
        <div class="col-6">
            <label class="small text-muted mb-1 ms-1">Тип сделки</label>
            <select id="addType" class="inp">
                <option value="sell">Продажа</option>
                <option value="buy">Скупка</option>
                <option value="rent">Аренда</option>
            </select>
        </div>
        <div class="col-6">
            <label class="small text-muted mb-1 ms-1">Категория</label>
            <select id="addCat" class="inp">
                <option value="cat_car">Транспорт</option>
                <option value="cat_acc">Аксессуары</option>
                <option value="cat_house">Дома/Кв</option>
                <option value="cat_biz">Бизнес</option>
                <option value="cat_sim">Сим-карты</option>
                <option value="cat_other">Разное</option>
            </select>
        </div>
    </div>

    <label class="small text-muted mb-1 ms-1">Сервер</label>
    <select id="addServer" class="inp">
        <option value="CO">Центральный Округ</option>
        <option value="YO">Южный Округ</option>
        <option value="SO">Северный Округ</option>
        <option value="PO">Приморский Округ</option>
        <option value="ZO">Западный Округ</option>
        <option value="VO">Восточный Округ</option>
    </select>

    <input type="text" id="addTitle" class="inp" placeholder="Название (напр. Шар Красный +12)">
    
    <label class="small text-muted mb-1 ms-1">Цена (Макс. 50 млрд)</label>
    <input type="number" id="addPrice" class="inp" placeholder="Вирты">
    
    <input type="text" id="addSocial" class="inp" placeholder="Связь (Ссылка VK / @TG / Discord)">
    
    <textarea id="addDesc" class="inp" rows="4" placeholder="Описание (тюнинг, финка, местоположение). Текст переносится автоматически."></textarea>
    
    <div class="mb-3" onclick="document.getElementById('addImgFile').click()">
        <div id="addImgPreview" style="height:120px; border:2px dashed var(--border); border-radius:14px; display:flex; flex-direction:column; gap:10px; align-items:center; justify-content:center; color:var(--text-muted); cursor:pointer; background: var(--bg-input);">
            <i class="fas fa-camera fa-2x"></i> 
            <span class="small">Добавить фото</span>
        </div>
    </div>
    <input type="file" id="addImgFile" hidden accept="image/*" onchange="handleMarketImg(this)">

    <button class="btn-main" onclick="publishItem()">Разместить объявление</button>
</div>

<!-- EDIT ITEM MODAL -->
<div class="sheet" id="modalEditItem">
    <h4 class="fw-bold mb-3">Редактирование</h4>
    <input type="hidden" id="editKey">
    
    <label class="small text-muted mb-1 ms-1">Название</label>
    <input type="text" id="editTitle" class="inp">
    
    <label class="small text-muted mb-1 ms-1">Цена (Макс. 50 млрд)</label>
    <input type="number" id="editPrice" class="inp">
    
    <label class="small text-muted mb-1 ms-1">Связь</label>
    <input type="text" id="editSocial" class="inp" placeholder="Ссылка или ник">

    <label class="small text-muted mb-1 ms-1">Описание</label>
    <textarea id="editDesc" class="inp" rows="4"></textarea>

    <button class="btn-main" onclick="saveEditItem()">Сохранить изменения</button>
    <button class="btn btn-outline-danger w-100 mt-2 rounded-3 p-3 fw-bold" onclick="closeAll()">Отмена</button>
</div>

<!-- CONTACT MODAL -->
<div class="sheet" id="modalContact">
    <h4 class="fw-bold mb-4 text-center">Связь с продавцом</h4>
    <div class="contact-modal-content">
        <div class="contact-row">
            <span class="text-muted"><i class="fas fa-user me-2"></i>Ник:</span>
            <b id="contactNick" class="text-white fs-5">...</b>
        </div>
        <div class="contact-row">
            <span class="text-muted"><i class="fas fa-comment-dots me-2"></i>Связь:</span>
            <b id="contactPhone" class="text-warning text-truncate" style="max-width:180px">...</b>
        </div>
        <div class="contact-row">
            <span class="text-muted"><i class="fas fa-server me-2"></i>Сервер:</span>
            <b id="contactServer" class="text-primary fs-5">...</b>
        </div>
        <a id="contactLinkBtn" href="#" target="_blank" class="btn btn-primary w-100 rounded-pill mt-3 py-3 fw-bold" style="display:none">
            <i class="fas fa-external-link-alt me-2"></i> Перейти к диалогу
        </a>
        <button class="btn btn-dark w-100 rounded-pill mt-2 py-3" onclick="closeAll()">Закрыть</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getDatabase, ref, push, onValue, get, update, remove, query, limitToLast, orderByChild } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

const DB_VER = 'pulse_rt_v6_'; 
const app = initializeApp({ apiKey: "AIzaSyBWdArSLBKMgWLAjq3DZ9xgcDUYsv10jvA", authDomain: "rodina-d57b8.firebaseapp.com", databaseURL: "https://rodina-d57b8-default-rtdb.firebaseio.com", projectId: "rodina-d57b8", storageBucket: "rodina-d57b8.firebasestorage.app", messagingSenderId: "102935590624", appId: "1:102935590624:web:4335fee01225bf018c0285" });
const db = getDatabase(app);

const MAX_PRICE = 50000000000; // 50 Billion Limit

let me = null;
let marketImg = null;
let allItems = [];
let currentFilter = 'all';

// INIT
async function init() {
    const localId = localStorage.getItem('pm_uid');
    if(!localId) { window.location.href = 'index.html'; return; }
    
    // Load User
    const s = await get(ref(db, `${DB_VER}users/${localId}`));
    if(s.exists()) { me = s.val(); }
    
    loadMarket();
}

function loadMarket() {
    onValue(ref(db, `${DB_VER}market`), snap => {
        const grid = document.getElementById('marketGrid');
        grid.innerHTML = '';
        allItems = [];
        
        if(!snap.exists()) {
            grid.innerHTML = '<div class="text-center text-muted w-100 mt-5">Рынок пока пуст<br><small>Станьте первым!</small></div>';
            return;
        }

        snap.forEach(c => {
            allItems.push({key:c.key, ...c.val()});
        });

        allItems.reverse(); // Newest first
        renderItems(allItems);
    });
}

window.renderItems = (items) => {
    const grid = document.getElementById('marketGrid');
    grid.innerHTML = '';
    
    if(items.length === 0) {
        grid.innerHTML = '<div class="text-center text-muted w-100 mt-5">Ничего не найдено</div>';
        return;
    }

    items.forEach(item => {
        let typeBadge = '';
        if(item.type === 'sell') typeBadge = '<span class="badge-base badge-type-sell">ПРОДАЖА</span>';
        if(item.type === 'buy') typeBadge = '<span class="badge-base badge-type-buy">СКУПКА</span>';
        if(item.type === 'rent') typeBadge = '<span class="badge-base badge-type-rent">АРЕНДА</span>';

        const imgUrl = item.img || 'https://placehold.co/600x400/222/555?text=No+Photo';
        const fmtPrice = new Intl.NumberFormat('ru-RU').format(item.price);

        // Manage Buttons (Only if ME)
        let manageHtml = '';
        if(me && item.authorId === me.id) {
            manageHtml = `
            <div class="manage-btns">
                <div class="btn-manage edit" onclick="openEditItem('${item.key}')"><i class="fas fa-pen"></i></div>
                <div class="btn-manage del" onclick="deleteItem('${item.key}')"><i class="fas fa-trash"></i></div>
            </div>`;
        }

        const html = `
        <div class="item-card">
            ${manageHtml}
            <img src="${imgUrl}" class="item-img" onclick="showContact('${item.authorName}', '${item.contactPhone || "В ЛС"}', '${item.server}')">
            <div class="item-content" onclick="showContact('${item.authorName}', '${item.contactPhone || "В ЛС"}', '${item.server}')">
                <div class="item-header-row">
                    <div class="item-title text-truncate">${item.title}</div>
                </div>
                
                <div class="item-badges">
                    <span class="badge-base badge-srv">${item.server}</span>
                    ${typeBadge}
                </div>
                
                <div class="item-desc">${item.desc}</div>
                
                <div class="item-price">${fmtPrice} <span>руб.</span></div>
            </div>
            <div class="item-footer" onclick="showContact('${item.authorName}', '${item.contactPhone || "В ЛС"}', '${item.server}')">
                <div class="seller-info">
                    <img src="${item.authorAva || 'https://placehold.co/50'}" class="seller-ava">
                    <span>${item.authorName}</span>
                </div>
                <div class="text-primary fw-bold" style="font-size:13px"><i class="far fa-comment-dots me-1"></i> Связаться</div>
            </div>
        </div>`;
        grid.innerHTML += html;
    });
}

window.filterItems = (filter, el) => {
    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
    currentFilter = filter;
    
    if(filter === 'all') {
        renderItems(allItems);
    } else if (['sell', 'buy', 'rent'].includes(filter)) {
        renderItems(allItems.filter(x => x.type === filter));
    } else {
        renderItems(allItems.filter(x => x.cat === filter));
    }
}

window.searchMarket = (val) => {
    if(!val) { renderItems(allItems); return; }
    const res = allItems.filter(x => 
        x.title.toLowerCase().includes(val.toLowerCase()) || 
        x.desc.toLowerCase().includes(val.toLowerCase())
    );
    renderItems(res);
}

// === ADD ITEM LOGIC ===
window.openAddModal = () => {
    document.getElementById('overlay').classList.add('open');
    document.getElementById('modalAddItem').classList.add('open');
}

window.handleMarketImg = (input) => {
    if(!input.files[0]) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        marketImg = e.target.result;
        document.getElementById('addImgPreview').style.backgroundImage = `url(${marketImg})`;
        document.getElementById('addImgPreview').style.backgroundSize = 'cover';
        document.getElementById('addImgPreview').innerHTML = '';
    };
    reader.readAsDataURL(input.files[0]);
}

window.publishItem = () => {
    const title = document.getElementById('addTitle').value.trim();
    const priceInput = document.getElementById('addPrice').value;
    const desc = document.getElementById('addDesc').value.trim();
    const type = document.getElementById('addType').value;
    const cat = document.getElementById('addCat').value;
    const server = document.getElementById('addServer').value;
    const social = document.getElementById('addSocial').value.trim();

    if(!title || !priceInput) return alert("Укажите название и цену");
    
    // VALIDATE PRICE
    const price = parseInt(priceInput);
    if(price > MAX_PRICE) {
        return alert("Максимальная цена — 50 000 000 000!");
    }
    if(price < 0) return alert("Цена не может быть отрицательной");

    const itemData = {
        authorId: me.id,
        authorName: me.name,
        authorAva: me.photo,
        contactPhone: social || "В игре", 
        title, price: price, desc, type, cat, server,
        img: marketImg,
        ts: Date.now()
    };

    push(ref(db, `${DB_VER}market`), itemData).then(() => {
        closeAll();
        document.getElementById('addTitle').value = '';
        document.getElementById('addPrice').value = '';
        document.getElementById('addDesc').value = '';
        document.getElementById('addSocial').value = '';
        marketImg = null;
        document.getElementById('addImgPreview').style.background = 'var(--bg-input)';
        document.getElementById('addImgPreview').innerHTML = '<i class="fas fa-camera fa-2x"></i><span class="small">Добавить фото</span>';
        alert("Объявление опубликовано!");
    });
}

// === MANAGE ITEMS ===
window.deleteItem = (key) => {
    if(confirm("Удалить это объявление?")) {
        remove(ref(db, `${DB_VER}market/${key}`));
    }
}

window.openEditItem = (key) => {
    const item = allItems.find(x => x.key === key);
    if(!item) return;

    document.getElementById('editKey').value = key;
    document.getElementById('editTitle').value = item.title;
    document.getElementById('editPrice').value = item.price;
    document.getElementById('editDesc').value = item.desc;
    document.getElementById('editSocial').value = item.contactPhone || '';

    document.getElementById('overlay').classList.add('open');
    document.getElementById('modalEditItem').classList.add('open');
}

window.saveEditItem = () => {
    const key = document.getElementById('editKey').value;
    const title = document.getElementById('editTitle').value.trim();
    const priceInput = document.getElementById('editPrice').value;
    const desc = document.getElementById('editDesc').value.trim();
    const social = document.getElementById('editSocial').value.trim();

    if(!title || !priceInput) return alert("Заполните поля");

    // VALIDATE PRICE
    const price = parseInt(priceInput);
    if(price > MAX_PRICE) {
        return alert("Максимальная цена — 50 000 000 000!");
    }

    update(ref(db, `${DB_VER}market/${key}`), {
        title, 
        price: price,
        desc,
        contactPhone: social || "В игре"
    }).then(() => {
        closeAll();
        alert("Изменения сохранены");
    });
}

// === CONTACT ===
window.showContact = (name, phone, srv) => {
    document.getElementById('contactNick').innerText = name;
    document.getElementById('contactPhone').innerText = phone;
    document.getElementById('contactServer').innerText = srv;
    
    const btn = document.getElementById('contactLinkBtn');
    if(phone.startsWith('http') || phone.startsWith('vk.com') || phone.startsWith('t.me') || phone.startsWith('discord')) {
        let url = phone;
        if(!url.startsWith('http')) url = 'https://' + url;
        btn.href = url;
        btn.style.display = 'block';
    } else {
        btn.style.display = 'none';
    }
    
    document.getElementById('overlay').classList.add('open');
    document.getElementById('modalContact').classList.add('open');
}

window.closeAll = () => {
    document.getElementById('overlay').classList.remove('open');
    document.querySelectorAll('.sheet').forEach(s => s.classList.remove('open'));
}

init();
</script>
</body>
</html>