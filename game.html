<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Alpaca Match - PvP Fixed</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;600;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
:root {
    --primary: #a855f7; --accent: #ec4899; --glass: rgba(255, 255, 255, 0.1);
    --tile-w: 60px; --tile-h: 68px;
    --danger: #ef4444; --success: #22c55e;
}

body {
    font-family: 'Outfit', sans-serif; margin: 0; height: 100dvh; overflow: hidden;
    background: linear-gradient(180deg, #1e1b4b 0%, #312e81 100%);
    color: white; user-select: none;
}

canvas { position: fixed; inset: 0; pointer-events: none; z-index: 5; }

/* HEADER */
.header {
    position: absolute; top: 0; left: 0; right: 0; z-index: 300;
    padding: 15px; display: flex; justify-content: space-between; align-items: flex-start;
}
.stat-pill {
    background: rgba(0,0,0,0.4); backdrop-filter: blur(15px);
    padding: 6px 14px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.15);
    font-size: 14px; display: flex; align-items: center; gap: 8px; margin-bottom: 5px;
}

/* PVP HUD */
.pvp-hud {
    display: none; width: 100%; max-width: 320px; margin: 0 auto;
    background: rgba(0,0,0,0.6); padding: 8px 12px; border-radius: 16px;
    border: 1px solid rgba(255,50,50,0.3); position: relative;
    backdrop-filter: blur(10px);
}
.pvp-active .pvp-hud { display: block; }
.pvp-bar-row { display: flex; align-items: center; gap: 10px; font-size: 12px; font-weight: 700; margin-bottom: 4px; }
.pvp-ava-mini { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; border: 1px solid #fff; }
.pvp-progress { flex: 1; height: 10px; background: rgba(255,255,255,0.1); border-radius: 6px; overflow: hidden; }
.pvp-fill { height: 100%; transition: width 0.3s; }
.pvp-fill.me { background: linear-gradient(90deg, #a855f7, #ec4899); }
.pvp-fill.opp { background: linear-gradient(90deg, #ef4444, #f97316); }

/* BOARD */
.board { position: relative; width: 100%; height: 100%; z-index: 10; padding: 120px 10px 240px; }
.tile {
    position: absolute; width: var(--tile-w); height: var(--tile-h);
    background: #fff; border-radius: 12px; display: flex; align-items: center; justify-content: center;
    font-size: 30px; box-shadow: 0 5px 0 #9ca3af, 0 10px 20px rgba(0,0,0,0.3);
    cursor: pointer; transition: 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    color: #000;
}
.tile.blocked { filter: brightness(0.6) grayscale(0.4); pointer-events: none; }
.tile.selected { border: 2px solid var(--accent); transform: scale(1.05); }

/* FOOTER */
.footer {
    position: absolute; bottom: 0; left: 0; right: 0; z-index: 400;
    padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 12px;
}
.slot-bar {
    width: 100%; max-width: 400px; height: 75px;
    background: rgba(20,20,30,0.85); border-radius: 20px; border: 1px solid rgba(255,255,255,0.2);
    display: flex; align-items: center; justify-content: center; gap: 4px; padding: 0 10px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
.btn-tool {
    width: 50px; height: 50px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.2);
    background: var(--glass); color: white; font-size: 20px; backdrop-filter: blur(10px);
    transition: 0.2s;
}
.btn-tool:active { transform: scale(0.95); }
.btn-tool:disabled { opacity: 0.3; pointer-events: none; } /* –°—Ç–∏–ª—å –¥–ª—è –≤—ã–∫–ª—é—á–µ–Ω–Ω—ã—Ö */

.btn-pvp {
    background: linear-gradient(135deg, #ef4444, #b91c1c); border: none;
    box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); position: relative; overflow: hidden;
}
.btn-pvp::after {
    content:''; position: absolute; inset:0; background: linear-gradient(45deg, transparent, rgba(255,255,255,0.4), transparent);
    animation: shine 2s infinite;
}
@keyframes shine { 0% {transform: translateX(-100%)} 100% {transform: translateX(100%)} }

/* MODALS */
.modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000;
    display: none; flex-direction: column; align-items: center; justify-content: center;
    backdrop-filter: blur(15px); text-align: center; padding: 30px;
}
.modal-card {
    background: #1e1e24; border: 1px solid rgba(255,255,255,0.1);
    padding: 30px; border-radius: 30px; width: 100%; max-width: 350px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
}
.modal-active { display: flex !important; }

/* SEARCH ANIMATION */
.radar {
    width: 80px; height: 80px; border-radius: 50%; border: 4px solid #ef4444;
    position: relative; margin: 0 auto 20px;
    box-shadow: 0 0 20px #ef4444, inset 0 0 20px #ef4444;
}
.radar::after {
    content:''; position:absolute; top:50%; left:50%; width:50%; height:2px; background:#fff;
    transform-origin: 0 0; animation: radarSpin 1.5s linear infinite;
}
@keyframes radarSpin { 0% {transform: rotate(0deg)} 100% {transform: rotate(360deg)} }

/* VS SCREEN */
.vs-container {
    display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px;
}
.vs-ava { width: 80px; height: 80px; border-radius: 50%; border: 4px solid #fff; object-fit: cover; }
.vs-badge { font-size: 30px; font-weight: 900; color: #ef4444; font-style: italic; }

</style>
</head>
<body data-season="summer">

<canvas id="weatherCanvas"></canvas>

<!-- HEADER -->
<div class="header">
    <div class="d-flex flex-column">
        <div class="stat-pill clickable" onclick="window.location.href='index.html'">
            <i class="fas fa-chevron-left"></i> –ù–∞–∑–∞–¥
        </div>
        <div class="stat-pill">
            <img src="" id="uiAvatar" class="rounded-circle" width="24">
            <span id="uiName" class="fw-bold">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
    </div>

    <!-- PVP HUD -->
    <div class="pvp-hud" id="pvpHud">
        <div class="text-center text-danger fw-black small mb-2 tracking-widest">‚öîÔ∏è DUEL ‚öîÔ∏è</div>
        <div class="pvp-bars">
            <div class="pvp-bar-row">
                <img src="" id="hudMeAva" class="pvp-ava-mini">
                <div class="pvp-progress"><div class="pvp-fill me" id="barMe" style="width:0%"></div></div>
            </div>
            <div class="pvp-bar-row">
                <img src="" id="hudOppAva" class="pvp-ava-mini">
                <div class="pvp-progress"><div class="pvp-fill opp" id="barOpp" style="width:0%"></div></div>
            </div>
        </div>
    </div>

    <div class="d-flex flex-column align-items-end">
        <div class="stat-pill text-warning fw-bold">
            <span id="uiCoins">0</span> ü™ô
        </div>
        <div class="stat-pill" id="tilesCounter">
            üé≤ <span id="uiTilesLeft">0</span>
        </div>
    </div>
</div>

<div class="board" id="board"></div>

<!-- FOOTER -->
<div class="footer">
    <div class="slot-bar" id="slotItems"></div>
    <div class="d-flex gap-3 align-items-end">
        <!-- –ö–ù–û–ü–ö–ê PVP -->
        <div class="text-center" id="btnPvPContainer">
            <button class="btn-tool btn-pvp" onclick="window.findMatch()">
                <i class="fas fa-skull"></i>
            </button>
            <div class="small fw-bold mt-1 text-danger">–û–ù–õ–ê–ô–ù</div>
            <div style="font-size:10px" class="opacity-50">50 ü™ô</div>
        </div>

        <!-- –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ (–†–∞–±–æ—Ç–∞—é—Ç –≤–µ–∑–¥–µ) -->
        <div class="text-center tool-group">
            <button class="btn-tool" onclick="window.useBomb()"><i class="fas fa-bomb"></i></button>
            <div class="small fw-bold mt-1">100 ü™ô</div>
        </div>
        <div class="text-center tool-group">
            <button class="btn-tool" onclick="window.undo()"><i class="fas fa-undo"></i></button>
            <div class="small fw-bold mt-1">UNDO</div>
        </div>
        <div class="text-center tool-group">
            <button class="btn-tool" onclick="window.shuffle()"><i class="fas fa-random"></i></button>
            <div class="small fw-bold mt-1">MIX</div>
        </div>
    </div>
</div>

<!-- MODAL: SEARCH -->
<div class="modal-overlay" id="searchModal">
    <div class="modal-card">
        <div class="radar"></div>
        <h2 class="fw-bold mb-2">–ü–æ–∏—Å–∫...</h2>
        <p class="text-muted">–ò—â–µ–º —Å–æ–ø–µ—Ä–Ω–∏–∫–∞</p>
        <p class="small text-warning">–°—Ç–∞–≤–∫–∞: 50 ü™ô</p>
        <button class="btn btn-outline-light rounded-pill px-4 mt-3" onclick="window.cancelSearch()">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<!-- MODAL: VS SCREEN -->
<div class="modal-overlay" id="vsModal" style="z-index: 2100;">
    <div class="modal-card bg-transparent border-0 shadow-none">
        <h1 class="fw-black text-danger mb-5" style="font-size: 40px; text-shadow: 0 0 20px black;">BATTLE START!</h1>
        <div class="vs-container">
            <div class="text-center">
                <img id="vsMeAva" class="vs-ava" style="border-color: #a855f7;">
                <div class="mt-2 fw-bold" id="vsMeName">You</div>
            </div>
            <div class="vs-badge">VS</div>
            <div class="text-center">
                <img id="vsOppAva" class="vs-ava" style="border-color: #ef4444;">
                <div class="mt-2 fw-bold" id="vsOppName">Enemy</div>
            </div>
        </div>
        <div class="spinner-border text-light mt-4"></div>
    </div>
</div>

<!-- MODAL: PVP END -->
<div class="modal-overlay" id="pvpEndModal">
    <div class="modal-card">
        <div style="font-size:60px" id="pvpIcon">üèÜ</div>
        <h1 class="fw-black my-3" id="pvpTitle">–ü–û–ë–ï–î–ê!</h1>
        <p id="pvpMsg" class="mb-4">–í—ã —É–Ω–∏—á—Ç–æ–∂–∏–ª–∏ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞!</p>
        <h3 class="text-warning fw-bold mb-4" id="pvpPrize">+90 ü™ô</h3>
        <button class="btn btn-light w-100 rounded-pill fw-bold py-3" onclick="location.reload()">–í –ú–ï–ù–Æ</button>
    </div>
</div>

<!-- MODAL: SOLO WIN/LOSE -->
<div class="modal-overlay" id="soloModal">
    <div class="modal-card">
        <div style="font-size:60px" id="soloIcon">ü¶ô</div>
        <h2 class="fw-bold mb-3" id="soloTitle">...</h2>
        <button class="btn btn-primary w-100 rounded-pill py-3 fw-bold" onclick="window.nextLevel()">–î–ê–õ–ï–ï</button>
        <button class="btn btn-outline-light w-100 rounded-pill py-3 fw-bold mt-2" onclick="location.reload()">–ó–ê–ù–û–í–û</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getDatabase, ref, onValue, runTransaction, get, set, update, remove, onDisconnect, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

const app = initializeApp({ apiKey: "AIzaSyBWdArSLBKMgWLAjq3DZ9xgcDUYsv10jvA", authDomain: "rodina-d57b8.firebaseapp.com", databaseURL: "https://rodina-d57b8-default-rtdb.firebaseio.com", projectId: "rodina-d57b8" });
const db = getDatabase(app);

// === –ì–ï–ù–ï–†–ê–¢–û–† –ê–í–ê–¢–ê–†–û–ö (–ó–ê–ì–õ–£–®–ö–ê) ===
// –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∞–≤–∞—Ç–∞—Ä–∫–∏, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤—É—é
const getRandomColor = () => {
    const colors = ['FF5733', '33FF57', '3357FF', 'F333FF', '33FFF3', 'F3FF33'];
    return colors[Math.floor(Math.random() * colors.length)];
}

const EMOJIS = ['üçì', 'üçè', 'üçÑ', 'ü•ï', 'üåΩ', 'üß∂', 'ü•õ', 'üå≤', 'üåª', 'üçí', 'ü••', 'üçé', 'üíé', 'üî•', '‚ö°'];
let uid = localStorage.getItem('pm_uid');
if(!uid) {
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID –¥–ª—è —Ç–µ—Å—Ç–∞, –µ—Å–ª–∏ –Ω–µ—Ç –≤—Ö–æ–¥–∞
    uid = 'user_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('pm_uid', uid);
}

let gameData = { coins: 0, level: 1, name: null, ava: null };
let tiles = [], slot = [], history = [];
let isPvP = false;
let matchId = null;
let searchTimeout = null;

// PRNG –¥–ª—è –æ–±—â–µ–≥–æ —Ä–∞–Ω–¥–æ–º–∞ (—á—Ç–æ–±—ã –ø–æ–ª–µ –±—ã–ª–æ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º —É –æ–±–æ–∏—Ö)
function mulberry32(a) {
    return function() {
        var t = a += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    }
}
let random = Math.random;

// --- –ê–¢–ú–û–°–§–ï–†–ê ---
function initAtmosphere() {
    const canvas = document.getElementById('weatherCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    let particles = [];
    for(let i=0; i<40; i++) particles.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, v: Math.random()*0.5+0.2, s: Math.random()*2 });
    function animate() {
        ctx.clearRect(0,0, canvas.width, canvas.height);
        ctx.fillStyle = "rgba(255,255,255,0.3)";
        particles.forEach(p => {
            ctx.beginPath(); ctx.arc(p.x, p.y, p.s, 0, Math.PI*2); ctx.fill();
            p.y -= p.v; if(p.y < -10) p.y = canvas.height;
        });
        requestAnimationFrame(animate);
    }
    animate();
}

// --- –õ–û–ì–ò–ö–ê –ò–ì–†–´ ---
window.startGame = (level, pvpSeed = null) => {
    const board = document.getElementById('board');
    board.innerHTML = ''; tiles = []; slot = []; history = [];
    document.getElementById('slotItems').innerHTML = '';
    
    if(pvpSeed) {
        isPvP = true;
        random = mulberry32(pvpSeed); // –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Ä–∞–Ω–¥–æ–º
        document.body.classList.add('pvp-active');
        // –ö–Ω–æ–ø–∫–∏ –¢–ï–ü–ï–†–¨ –†–ê–ë–û–¢–ê–Æ–¢ (—É–±—Ä–∞–Ω –±–ª–æ–∫ disabled)
        document.getElementById('btnPvPContainer').style.display = 'none';
        level = 3 + Math.floor(random() * 5); 
    } else {
        isPvP = false;
        random = Math.random;
        document.body.classList.remove('pvp-active');
    }

    const tripletsCount = isPvP ? 15 : (6 + Math.min(level, 15));
    let deck = [];
    for(let i=0; i<tripletsCount; i++) {
        let emo = EMOJIS[i % EMOJIS.length];
        deck.push(emo, emo, emo);
    }
    // Shuffle
    for (let i = deck.length - 1; i > 0; i--) {
        const j = Math.floor(random() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
    }

    deck.forEach((emo, i) => {
        const div = document.createElement('div');
        div.className = 'tile'; div.innerText = emo;
        
        // –°–ø–∏—Ä–∞–ª—å–Ω–∞—è —Ä–∞—Å–∫–ª–∞–¥–∫–∞
        const layer = Math.floor(i / 12);
        const angle = i * 0.5;
        const radius = layer * 35 + 30;
        const x = (window.innerWidth/2 - 30) + (Math.cos(angle) * radius);
        const y = (window.innerHeight/2 - 140) + (Math.sin(angle) * radius);
        
        div.style.left = x + 'px'; div.style.top = y + 'px'; div.style.zIndex = layer + 10;
        const t = { id: i, emo, el: div, x, y, z: layer+10 };
        div.onclick = () => pickTile(t);
        tiles.push(t); board.appendChild(div);
    });
    updateUI();
}

function pickTile(t) {
    if(slot.length >= 7) return;
    if(t.el.classList.contains('blocked')) return;

    if(!isPvP) history.push({...t}); // Undo —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ —Å–æ–ª–æ, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω
    
    slot.push(t);
    t.el.style.position = 'relative'; t.el.style.left = '0'; t.el.style.top = '0';
    t.el.style.transform = 'scale(0.85)'; t.el.style.margin = '0 -4px'; t.el.style.zIndex = 999;
    document.getElementById('slotItems').appendChild(t.el);
    
    updateUI(); 
    setTimeout(checkMatches, 150);
}

function checkMatches() {
    const counts = {};
    slot.forEach(t => counts[t.emo] = (counts[t.emo] || 0) + 1);
    
    let matched = false;
    for(let emo in counts) {
        if(counts[emo] >= 3) {
            let rem = 0;
            slot = slot.filter(t => {
                if(t.emo === emo && rem < 3) { 
                    t.el.style.transform = 'scale(0)'; 
                    setTimeout(()=>t.el.remove(), 200);
                    rem++; return false; 
                }
                return true;
            });
            matched = true;
            if(isPvP) updatePvPProgress();
            break;
        }
    }

    if(!matched && slot.length === 7) {
        if(isPvP) {
            // –í PvP –ø–æ–ª–Ω—ã–π —Å–ª–æ—Ç = —Ç—É–ø–∏–∫
        } else {
            showSoloModal(false);
        }
        return;
    }

    const tilesOnBoard = tiles.filter(t => t.el.parentElement === document.getElementById('board')).length;
    if(tilesOnBoard === 0 && slot.length === 0) {
        confetti({particleCount: 150, spread: 80, origin: { y: 0.6 }});
        if(isPvP) reportWin(); else showSoloModal(true);
    }
    updateUI();
}

function updateUI() {
    const boardTiles = tiles.filter(t => t.el.parentElement === document.getElementById('board'));
    document.getElementById('uiTilesLeft').innerText = boardTiles.length;
    boardTiles.forEach(t1 => {
        let isBlocked = boardTiles.some(t2 => t2.z > t1.z && Math.hypot(t1.x - t2.x, t1.y - t2.y) < 40);
        t1.el.classList.toggle('blocked', isBlocked);
    });
}

// --- PVP SEARCH ---
window.findMatch = async () => {
    // –ü–†–û–í–ï–†–ö–ê: –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å, –Ω–µ –ø—É—Å–∫–∞–µ–º
    if(!gameData.name) {
        alert("–ü–æ–¥–æ–∂–¥–∏—Ç–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è...");
        return;
    }

    if(gameData.coins < 50) return alert('–ù—É–∂–Ω–æ 50 –º–æ–Ω–µ—Ç!');
    await runTransaction(ref(db, `pulse_rt_v6_users/${uid}/coins`), c => (c||0) - 50);
    
    document.getElementById('searchModal').classList.add('modal-active');
    
    // 1. –°–º–æ—Ç—Ä–∏–º –æ—á–µ—Ä–µ–¥—å
    const queueRef = ref(db, 'pulse_pvp_queue');
    const snap = await get(queueRef);
    let opponent = null;

    if(snap.exists()) {
        const q = snap.val();
        // –ò—â–µ–º –ª—é–±–æ–≥–æ, —á–µ–π ID –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –º–æ–∏–º
        const oppId = Object.keys(q).find(k => k !== uid);
        if(oppId) {
            opponent = { id: oppId, ...q[oppId] };
            await remove(ref(db, `pulse_pvp_queue/${oppId}`)); // –ó–∞–±–∏—Ä–∞–µ–º –∏–∑ –æ—á–µ—Ä–µ–¥–∏
        }
    }

    if(opponent) {
        // –ú—ã –Ω–∞—à–ª–∏ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞! –°–æ–∑–¥–∞–µ–º –º–∞—Ç—á
        createMatch(opponent);
    } else {
        // –ù–∏–∫–æ–≥–æ –Ω–µ—Ç, –≤—Å—Ç–∞–µ–º –≤ –æ—á–µ—Ä–µ–¥—å
        // –í–ê–ñ–ù–û: –ü–∏—à–µ–º —Å–≤–æ–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        await set(ref(db, `pulse_pvp_queue/${uid}`), { 
            name: gameData.name, 
            ava: gameData.ava, 
            ts: Date.now() 
        });
        onDisconnect(ref(db, `pulse_pvp_queue/${uid}`)).remove();
        
        // –°–ª—É—à–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ç—á–∞, –≥–¥–µ –º—ã –±—É–¥–µ–º –ò–≥—Ä–æ–∫–æ–º 2
        listenForMatch();
    }
}

async function createMatch(oppData) {
    const newMatchId = 'm_' + Date.now() + '_' + Math.random().toString(36).substr(2,5);
    matchId = newMatchId;
    const seed = Math.floor(Math.random() * 1000000); 
    
    const matchData = {
        p1: uid, 
        p1Data: {name: gameData.name, ava: gameData.ava}, // –ú–æ–∏ –¥–∞–Ω–Ω—ã–µ
        p2: oppData.id,
        p2Data: {name: oppData.name, ava: oppData.ava},   // –î–∞–Ω–Ω—ã–µ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞
        seed: seed,
        status: 'playing', winner: null,
        progress: { [uid]: 0, [oppData.id]: 0 }
    };
    
    await set(ref(db, `pulse_pvp_matches/${matchId}`), matchData);
    
    // –°—Ç–∞—Ä—Ç –∫–∞–∫ –ò–≥—Ä–æ–∫ 1
    startPvPSequence(oppData.name, oppData.ava, seed);
}

function listenForMatch() {
    const matchesRef = ref(db, 'pulse_pvp_matches');
    const q = query(matchesRef, orderByChild('p2'), equalTo(uid));
    
    const unsub = onValue(q, (snap) => {
        if(!snap.exists()) return;
        snap.forEach(child => {
            const m = child.val();
            if(m.status === 'playing') {
                remove(ref(db, `pulse_pvp_queue/${uid}`));
                matchId = child.key;
                unsub();
                
                // –°—Ç–∞—Ä—Ç –∫–∞–∫ –ò–≥—Ä–æ–∫ 2. –î–∞–Ω–Ω—ã–µ –ò–≥—Ä–æ–∫–∞ 1 –±–µ—Ä–µ–º –∏–∑ –º–∞—Ç—á–∞
                const p1Name = (m.p1Data && m.p1Data.name) ? m.p1Data.name : 'Unknown';
                const p1Ava = (m.p1Data && m.p1Data.ava) ? m.p1Data.ava : `https://placehold.co/100?text=${p1Name[0]}`;
                
                startPvPSequence(p1Name, p1Ava, m.seed);
            }
        });
    });
    
    searchTimeout = setTimeout(async () => {
        unsub();
        await remove(ref(db, `pulse_pvp_queue/${uid}`));
        await runTransaction(ref(db, `pulse_rt_v6_users/${uid}/coins`), c => (c||0) + 50);
        document.getElementById('searchModal').classList.remove('modal-active');
        alert("–ù–∏–∫–æ–≥–æ –Ω–µ—Ç. –ú–æ–Ω–µ—Ç—ã –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã.");
    }, 30000);
}

window.cancelSearch = async () => {
    if(searchTimeout) clearTimeout(searchTimeout);
    await remove(ref(db, `pulse_pvp_queue/${uid}`));
    await runTransaction(ref(db, `pulse_rt_v6_users/${uid}/coins`), c => (c||0) + 50);
    location.reload();
}

function startPvPSequence(oppName, oppAva, seed) {
    if(searchTimeout) clearTimeout(searchTimeout);
    document.getElementById('searchModal').classList.remove('modal-active');

    // –≠–∫—Ä–∞–Ω VS
    document.getElementById('vsMeAva').src = gameData.ava;
    document.getElementById('vsMeName').innerText = gameData.name;
    document.getElementById('vsOppAva').src = oppAva;
    document.getElementById('vsOppName').innerText = oppName;
    document.getElementById('vsModal').classList.add('modal-active');

    // HUD
    document.getElementById('hudMeAva').src = gameData.ava;
    document.getElementById('hudOppAva').src = oppAva;

    setTimeout(() => {
        document.getElementById('vsModal').classList.remove('modal-active');
        startGame(1, seed);
        listenMatchProgress();
    }, 3000);
}

function listenMatchProgress() {
    if(!matchId) return;
    onValue(ref(db, `pulse_pvp_matches/${matchId}`), s => {
        const m = s.val();
        if(!m) return;
        
        const oppId = m.p1 === uid ? m.p2 : m.p1;
        const oppProg = m.progress && m.progress[oppId] ? m.progress[oppId] : 0;
        
        document.getElementById('barOpp').style.width = oppProg + '%';

        if(m.winner) {
            endPvP(m.winner === uid);
        }
    });
}

function updatePvPProgress() {
    if(!matchId) return;
    const startCount = tiles.length;
    const currentCount = tiles.filter(t => t.el.parentElement === document.getElementById('board')).length;
    const percent = Math.floor(((startCount - currentCount) / startCount) * 100);
    
    document.getElementById('barMe').style.width = percent + '%';
    update(ref(db, `pulse_pvp_matches/${matchId}/progress`), { [uid]: percent });
}

async function reportWin() {
    if(!matchId) return;
    const res = await runTransaction(ref(db, `pulse_pvp_matches/${matchId}/winner`), curr => {
        return curr === null ? uid : undefined;
    });
}

function endPvP(iWon) {
    const modal = document.getElementById('pvpEndModal');
    if(iWon) {
        document.getElementById('pvpTitle').innerText = '–ü–û–ë–ï–î–ê!';
        document.getElementById('pvpTitle').className = 'fw-black my-3 text-warning';
        document.getElementById('pvpIcon').innerText = 'üëë';
        document.getElementById('pvpMsg').innerText = '–í—ã –±—ã—Å—Ç—Ä–µ–µ!';
        document.getElementById('pvpPrize').style.display = 'block';
        runTransaction(ref(db, `pulse_rt_v6_users/${uid}/coins`), c => (c||0) + 90);
    } else {
        document.getElementById('pvpTitle').innerText = '–ü–û–†–ê–ñ–ï–ù–ò–ï';
        document.getElementById('pvpTitle').className = 'fw-black my-3 text-danger';
        document.getElementById('pvpIcon').innerText = 'üíÄ';
        document.getElementById('pvpMsg').innerText = '–°–æ–ø–µ—Ä–Ω–∏–∫ –ø–æ–±–µ–¥–∏–ª...';
        document.getElementById('pvpPrize').style.display = 'none';
    }
    modal.classList.add('modal-active');
    setTimeout(() => { if(matchId) remove(ref(db, `pulse_pvp_matches/${matchId}`)); }, 5000);
}

// SOLO HELPERS
window.showSoloModal = (win) => {
    const m = document.getElementById('soloModal');
    if(win) {
        document.getElementById('soloIcon').innerText = 'üéâ';
        document.getElementById('soloTitle').innerText = '–£–†–û–í–ï–ù–¨ –ü–†–û–ô–î–ï–ù!';
        document.querySelector('#soloModal .btn-primary').style.display = 'block';
    } else {
        document.getElementById('soloIcon').innerText = 'ü•Ä';
        document.getElementById('soloTitle').innerText = '–¢–£–ü–ò–ö...';
        document.querySelector('#soloModal .btn-primary').style.display = 'none';
    }
    m.classList.add('modal-active');
}
window.nextLevel = () => {
    runTransaction(ref(db, `pulse_game_v1_users/${uid}/level`), l=>(l||1)+1).then(()=>location.reload());
}

// TOOLS
window.shuffle = () => {
    const active = tiles.filter(t => t.el.parentElement === document.getElementById('board'));
    const pos = active.map(t => ({x: t.x, y: t.y, z: t.z})).sort(() => Math.random() - 0.5);
    active.forEach((t, i) => {
        t.x = pos[i].x; t.y = pos[i].y; t.z = pos[i].z;
        t.el.style.left = t.x + 'px'; t.el.style.top = t.y + 'px'; t.el.style.zIndex = t.z;
    });
    updateUI();
};
window.undo = () => {
    if(history.length === 0) return;
    const last = history.pop();
    const idx = slot.findIndex(t => t.id === last.id);
    if(idx !== -1) {
        const t = slot.splice(idx, 1)[0];
        document.getElementById('board').appendChild(t.el);
        t.el.style.position = 'absolute'; t.el.style.left = t.x + 'px'; t.el.style.top = t.y + 'px';
        t.el.style.transform = 'none'; t.el.style.margin = '0'; t.el.style.zIndex = t.z;
    }
    updateUI();
};
window.useBomb = () => {
    if(gameData.coins < 100) return alert("–ú–∞–ª–æ –º–æ–Ω–µ—Ç!");
    const boardTiles = tiles.filter(t => t.el.parentElement === document.getElementById('board'));
    const counts = {}; boardTiles.forEach(t => counts[t.emo] = (counts[t.emo]||0)+1);
    const target = Object.keys(counts).find(e => counts[e] >= 3);
    if(target) {
        runTransaction(ref(db, `pulse_rt_v6_users/${uid}/coins`), c=>(c||0)-100);
        const toRemove = boardTiles.filter(t => t.emo === target).slice(0,3);
        toRemove.forEach(t => t.el.remove());
        updateUI();
    }
}

// INIT
onValue(ref(db, `pulse_rt_v6_users/${uid}`), s => {
    const d = s.val() || {};
    gameData.coins = d.coins || 0;
    
    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –∏ –∞–≤–∞—Ç–∞—Ä–∫–∏
    gameData.name = d.name || 'Gamer ' + Math.floor(Math.random()*1000);
    gameData.ava = d.photo || `https://placehold.co/100/${getRandomColor()}/FFF?text=${gameData.name[0]}`;

    document.getElementById('uiCoins').innerText = gameData.coins;
    document.getElementById('uiName').innerText = gameData.name;
    document.getElementById('uiAvatar').src = gameData.ava;
});
get(ref(db, `pulse_game_v1_users/${uid}/level`)).then(s => {
    gameData.level = s.val() || 1;
    startGame(gameData.level);
});
initAtmosphere();

</script>
</body>
</html>