<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>PULSE TOP</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

<style>
:root {
    --bg-body: #050505;
    --card-bg: rgba(255, 255, 255, 0.03);
    --card-border: rgba(255, 255, 255, 0.08);
    --text-main: #ffffff;
    --text-muted: #9ca3af;
    
    /* Цвета пламени (будут меняться динамически) */
    --f-lvl1: #f97316; /* Оранжевый */
    --f-lvl5: #06b6d4; /* Циан */
    --f-lvl10: #d946ef; /* Фуксия */
    --f-lvl15: #22c55e; /* Зеленый */
    --f-lvl20: #ef4444; /* Красный */
    
    /* Ранги */
    --gold: linear-gradient(135deg, #fbbf24, #d97706);
    --silver: linear-gradient(135deg, #e2e8f0, #94a3b8);
    --bronze: linear-gradient(135deg, #d97706, #78350f);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
    font-family: 'Manrope', sans-serif;
    background: radial-gradient(circle at top center, #1a1a2e, var(--bg-body));
    color: var(--text-main);
    margin: 0;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

/* --- ШАПКА --- */
.app-header {
    padding: 15px 20px;
    padding-top: max(15px, env(safe-area-inset-top));
    display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 100;
    background: rgba(5, 5, 5, 0.8);
    backdrop-filter: blur(15px);
    border-bottom: 1px solid var(--card-border);
}

.brand {
    font-weight: 900; font-size: 18px; letter-spacing: 2px;
    text-transform: uppercase;
    background: linear-gradient(to right, #fff, #a1a1aa);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}

.btn-icon {
    background: rgba(255,255,255,0.05); border: 1px solid var(--card-border);
    color: var(--text-main); width: 40px; height: 40px; border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; cursor: pointer; transition: 0.2s;
}
.btn-icon:active { transform: scale(0.95); background: rgba(255,255,255,0.1); }

/* --- СПИСОК --- */
.container {
    padding: 20px 15px;
    max-width: 600px;
    margin: 0 auto;
    width: 100%;
    flex: 1;
}

.top-header {
    text-align: center; margin-bottom: 25px; position: relative;
}
.top-title {
    font-size: 26px; font-weight: 800;
    background: linear-gradient(135deg, #fff 30%, #6366f1);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.top-subtitle {
    font-size: 13px; color: var(--text-muted); margin-top: 5px; letter-spacing: 0.5px;
}

/* КАРТОЧКА ИГРОКА */
.top-item {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 24px;
    padding: 16px;
    margin-bottom: 12px;
    display: flex; align-items: center; gap: 15px;
    position: relative; overflow: hidden;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    
    /* Анимация появления */
    opacity: 0; transform: translateY(20px);
    animation: slideIn 0.5s forwards;
}

/* Задержка анимации для списка */
.top-item:nth-child(1) { animation-delay: 0.1s; }
.top-item:nth-child(2) { animation-delay: 0.15s; }
.top-item:nth-child(3) { animation-delay: 0.2s; }
.top-item:nth-child(n+4) { animation-delay: 0.25s; }

@keyframes slideIn { to { opacity: 1; transform: translateY(0); } }

.top-item:active { transform: scale(0.98); }

/* Свечение карточки при наведении */
.top-item::before {
    content: ''; position: absolute; inset: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.03), transparent);
    transform: translateX(-100%); transition: 0.5s;
    pointer-events: none;
}
.top-item:hover::before { transform: translateX(100%); }

/* ОСОБЫЕ СТИЛИ ДЛЯ ТОП 3 */
.top-item.rank-1 { background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(0,0,0,0)); border-color: rgba(251, 191, 36, 0.3); }
.top-item.rank-2 { background: linear-gradient(135deg, rgba(226, 232, 240, 0.05), rgba(0,0,0,0)); border-color: rgba(148, 163, 184, 0.3); }
.top-item.rank-3 { background: linear-gradient(135deg, rgba(180, 83, 9, 0.1), rgba(0,0,0,0)); border-color: rgba(180, 83, 9, 0.3); }

/* РАНГ (Цифра) */
.rank-num {
    font-size: 18px; font-weight: 800; width: 30px; text-align: center;
    color: var(--text-muted); font-family: 'Manrope', monospace;
}
.rank-1 .rank-num { font-size: 28px; background: var(--gold); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 20px rgba(251, 191, 36, 0.4); }
.rank-2 .rank-num { font-size: 24px; background: var(--silver); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.rank-3 .rank-num { font-size: 22px; background: var(--bronze); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

/* АВАТАРКИ ПАР */
.couple-box {
    position: relative; width: 64px; height: 56px; flex-shrink: 0;
}
.c-ava {
    width: 44px; height: 44px; border-radius: 16px; object-fit: cover;
    position: absolute; 
    border: 2px solid #18181b; /* Цвет фона карточки по дефолту */
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    transition: border-color 0.3s;
}
.c-ava:nth-child(1) { left: 0; top: 0; z-index: 2; }
.c-ava:nth-child(2) { right: 0; bottom: 0; z-index: 1; filter: brightness(0.7); }

/* ИНФОРМАЦИЯ */
.info { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; }
.names { font-weight: 700; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.top-item.rank-1 .names { color: #fbbf24; }

/* СТАТИСТИКА И ОГОНЕК */
.stats-row { display: flex; align-items: center; gap: 8px; font-size: 12px; }

.flame-tag {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 4px 10px; border-radius: 12px;
    font-weight: 700; font-size: 12px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    color: var(--flame-color);
    box-shadow: 0 0 10px var(--flame-glow);
    transition: 0.3s;
}

.fire-icon { animation: pulse 2s infinite; filter: drop-shadow(0 0 5px var(--flame-color)); }
@keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }

.flame-name { color: var(--text-muted); font-size: 13px; font-weight: 500; }

/* Уровни цвета */
.lvl-tier-1 { --flame-color: var(--f-lvl1); --flame-glow: rgba(249, 115, 22, 0.2); }
.lvl-tier-2 { --flame-color: var(--f-lvl5); --flame-glow: rgba(6, 182, 212, 0.2); }
.lvl-tier-3 { --flame-color: var(--f-lvl10); --flame-glow: rgba(217, 70, 239, 0.2); }
.lvl-tier-4 { --flame-color: var(--f-lvl15); --flame-glow: rgba(34, 197, 94, 0.2); }
.lvl-tier-5 { --flame-color: var(--f-lvl20); --flame-glow: rgba(239, 68, 68, 0.3); }

/* Обводка аватарок цветом уровня */
.lvl-tier-1 .c-ava { border-color: var(--f-lvl1); }
.lvl-tier-2 .c-ava { border-color: var(--f-lvl5); }
.lvl-tier-3 .c-ava { border-color: var(--f-lvl10); }
.lvl-tier-4 .c-ava { border-color: var(--f-lvl15); }
.lvl-tier-5 .c-ava { border-color: var(--f-lvl20); }

.loading { text-align: center; color: var(--text-muted); margin-top: 50px; font-size: 14px; animation: pulse 1s infinite; }
</style>
</head>
<body>

<div class="app-header">
    <button class="btn-icon" onclick="window.location.href='chat.html'">
        <i class="fas fa-arrow-left"></i>
    </button>
    <div class="brand">PULSE</div>
    <div style="width: 40px;"></div>
</div>

<div class="container">
    <div class="top-header">
        <div class="top-title">Зал Славы</div>
        <div class="top-subtitle">Самые горячие переписки</div>
    </div>
    
    <div id="topList">
        <div class="loading">Загрузка данных...</div>
    </div>
</div>

<script type="module">
    const DB_VER = 'pulse_rt_v6_';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBWdArSLBKMgWLAjq3DZ9xgcDUYsv10jvA",
        authDomain: "rodina-d57b8.firebaseapp.com",
        databaseURL: "https://rodina-d57b8-default-rtdb.firebaseio.com",
        projectId: "rodina-d57b8",
        storageBucket: "rodina-d57b8.appspot.com",
        messagingSenderId: "87881339832",
        appId: "1:87881339832:web:c2d61b2027c6a58bd281c5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Функция поиска
    function findUserInMap(map, targetId) {
        if (!targetId || !map) return null;
        if (map[targetId]) return map[targetId];
        const usersArray = Object.values(map);
        return usersArray.find(u => u && String(u.id) == String(targetId)) || null;
    }

    // Функция определения класса цвета по уровню
    function getTierClass(level) {
        if (!level) return 'lvl-tier-1';
        if (level >= 20) return 'lvl-tier-5'; // Красный/Золотой
        if (level >= 15) return 'lvl-tier-4'; // Зеленый
        if (level >= 10) return 'lvl-tier-3'; // Фиолетовый
        if (level >= 5)  return 'lvl-tier-2'; // Голубой
        return 'lvl-tier-1'; // Оранжевый (1-4)
    }

    async function loadTop() {
        const list = document.getElementById('topList');
        
        try {
            // Загрузка
            const usersSnap = await get(ref(db, `${DB_VER}users`));
            const usersMap = usersSnap.exists() ? usersSnap.val() : {};

            const flamesSnap = await get(ref(db, `${DB_VER}flames`));
            
            if (!flamesSnap.exists()) {
                list.innerHTML = '<div class="loading">Огоньков пока нет :(</div>';
                return;
            }

            const flames = [];
            flamesSnap.forEach(snap => { flames.push({ key: snap.key, ...snap.val() }); });
            flames.sort((a, b) => (b.points || 0) - (a.points || 0));

            list.innerHTML = '';
            
            flames.forEach((f, index) => {
                // Разбор ID
                const parts = f.key.split('_');
                let id1, id2;
                if (parts.length === 4 && parts[0] === 'u' && parts[2] === 'u') {
                    id1 = parts[0] + '_' + parts[1]; id2 = parts[2] + '_' + parts[3];
                } else {
                    id1 = parts[0]; id2 = parts[1] || parts[0]; 
                }

                const u1 = findUserInMap(usersMap, id1);
                const u2 = findUserInMap(usersMap, id2);
                const defImg = 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
                const name1 = u1 ? u1.name : "Неизвестный";
                const photo1 = u1 ? u1.photo : defImg;
                const name2 = u2 ? u2.name : "Неизвестный";
                const photo2 = u2 ? u2.photo : defImg;

                const rank = index + 1;
                const tierClass = getTierClass(f.level);

                const div = document.createElement('div');
                div.className = `top-item rank-${rank <= 3 ? rank : 'other'} ${tierClass}`;
                
                div.innerHTML = `
                    <div class="rank-num">${rank}</div>
                    <div class="couple-box">
                        <img src="${photo1}" class="c-ava" onerror="this.src='${defImg}'">
                        <img src="${photo2}" class="c-ava" onerror="this.src='${defImg}'">
                    </div>
                    <div class="info">
                        <div class="names">${name1} & ${name2}</div>
                        <div class="stats-row">
                            <span class="flame-name">"${f.name || 'Огонек'}"</span>
                            <div class="flame-tag">
                                <i class="fas fa-fire fire-icon"></i>
                                <span>${f.level} ур.</span>
                            </div>
                        </div>
                    </div>
                `;
                
                list.appendChild(div);
            });

        } catch (e) {
            console.error(e);
            list.innerHTML = `<div class="loading" style="color:#ef4444">Ошибка загрузки</div>`;
        }
    }

    loadTop();
</script>
</body>
</html>